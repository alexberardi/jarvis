---
description: Rules for jarvis-auth - JWT authentication microservice
globs: jarvis-auth/**
---

# jarvis-auth

FastAPI authentication microservice with JWT tokens, user management, and app-to-app credentials.

## Running (Port 7701)

```bash
./run.sh --docker              # Start in Docker (standard)
./run.sh --docker --rebuild    # Rebuild after dependency changes
./run-prod.sh                  # Production
pytest                         # Tests
```

## Architecture

```
jarvis_auth/app/
├── main.py                    # FastAPI app, middleware
├── api/
│   ├── auth.py                # Register, login, refresh, logout
│   ├── admin_app_clients.py   # App credential management
│   ├── admin_nodes.py         # Node management
│   └── internal.py            # Internal endpoints
├── db/
│   ├── models.py              # User, RefreshToken, AppClient, Node
│   └── session.py             # Database connection
└── core/
    └── security.py            # JWT, password hashing
```

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `DATABASE_URL` | - | PostgreSQL connection string |
| `SECRET_KEY` | - | JWT signing key (required) |
| `ACCESS_TOKEN_EXPIRE_MINUTES` | 30 | Access token lifetime |
| `REFRESH_TOKEN_EXPIRE_DAYS` | 7 | Refresh token lifetime |

## API Endpoints

**User Auth:**
- `POST /auth/register` - Create user
- `POST /auth/login` - Get access + refresh tokens
- `GET /auth/me` - Current user (requires Bearer token)
- `POST /auth/refresh` - Refresh access token
- `POST /auth/logout` - Revoke refresh token

**App-to-App (Admin):**
- `POST /admin/app-clients` - Create app credentials
- `GET /admin/app-clients` - List app clients

**Internal:**
- `POST /internal/validate-app` - Validate app credentials

## App-to-App Authentication

Other services authenticate via headers:
```
X-Jarvis-App-Id: ocr-service
X-Jarvis-App-Key: <app-key>
```
Validate by calling `/internal/validate-app`.

## Service Dependencies

**Leaf node** - jarvis-auth is at the bottom of the dependency chain. Other services depend on it, not the other way around.

- `jarvis-settings-client` - Runtime configuration (only jarvis library dependency)
- No log-client or config-client

**Data services (from jarvis-data-stores/):**
- PostgreSQL - User accounts, refresh tokens, app clients, node registry

## Dependencies

FastAPI, SQLAlchemy, Alembic, python-jose (JWT), passlib (bcrypt), httpx, jarvis-settings-client
