---
description: Rules for jarvis-logs - centralized logging service
globs: jarvis-logs/**
---

# jarvis-logs

Centralized logging service. Receives logs from microservices, stores in Loki, visualizes in Grafana.

## Running (Port 8006)

```bash
./run.sh --docker              # Start in Docker (Loki + Grafana + API)
./run.sh --docker --rebuild    # Rebuild after dependency changes
./run-tests.sh                 # Tests
# Grafana: http://localhost:8015 (admin/jarvis)
```

## Architecture

```
app/
├── main.py               # FastAPI app
├── routes/
│   ├── logs.py           # Log ingestion and querying
│   └── node_logs.py      # Node-specific logs
├── loki_client.py        # Loki push/query
└── auth.py               # App-to-app auth

docker-compose.yaml       # Loki (3100), Grafana (3000), API (8006)
```

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `LOKI_URL` | http://loki:3100 | Loki server URL |
| `LOG_SERVER_PORT` | 8006 | API port |
| `LOG_API_KEY` | - | API key for log ingestion |
| `ADMIN_API_KEY` | - | Admin endpoint protection |

## API Endpoints

**Ingestion:**
- `POST /api/v0/logs` - Single log
- `POST /api/v0/logs/batch` - Batch logs

**Querying:**
- `GET /api/v0/logs` - Query with filters (`?service=auth&level=ERROR&since_minutes=60`)
- `GET /api/v0/logs/stream` - Real-time stream (SSE)
- `GET /api/v0/services` - List services with logs

**Health:**
- `GET /health` - Health check

## Service Dependencies

**Must be running:**
- `jarvis-auth` (8007) - App-to-app and node auth validation
- `jarvis-config-service` (8013) - Service discovery (finds auth URL)
- `jarvis-settings-client` - Runtime configuration

**External (bundled in docker-compose):**
- Loki (3100) - Log storage/indexing
- Grafana (8015) - Dashboards

## Authentication

Clients authenticate via `X-Jarvis-App-Id` + `X-Jarvis-App-Key` headers, validated against jarvis-auth. Nodes authenticate via `X-API-Key` header.

## Dependencies

FastAPI, httpx, jarvis-config-client, jarvis-settings-client, Loki, Grafana
